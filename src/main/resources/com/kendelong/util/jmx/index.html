<!DOCTYPE html>
<html lang="en" ng-app="StabilityMetrics">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stability Utils Metrics</title>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<link rel="stylesheet" href="http://cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css">
	<style>
		tr.bg-info td {
			background-color: #d9edf7;
		}
	</style>

  </head>
  <body>
	<div class="container" ng-controller="MainCtrl as main">
	
		<div class="panel panel-info">
		  <!-- Default panel contents -->
		  <div class="panel-heading"><button type="button" class="btn btn-default" data-toggle="collapse" data-target="#performanceTable"  aria-expanded="true" aria-controls="performanceTable"><span class="caret"></button> Performance</div>
		  <div class="panel-body">
			<p>metrics</p>
		  </div>
		  <div class="collapse in" id="performanceTable">
		  <table class="table table-hover" id="perfTable">
			<thead>
			<tr>
				<th>Name</th>
				<th>Minimum</th>
				<th>Maximum</th>
				<th>Average</th>
				<th>Requests/min</th>
				<th>Exceptions</th>
				<th>Number of Accesses</th>
				<th>Cumulative Time</th>
			</tr>
			</thead>
			<tbody>
			<tr ng-repeat="service in main.performance" class="details-control">
				<td>{{ service.name }}</td>
				<td>{{ service.min }}</td>
				<td>{{ service.max }}</td>
				<td>{{ service.avg }}</td>
				<td>{{ service.rpm }}</td>
				<td>{{ service.ex }}</td>
				<td>{{ service.numAccess }}</td>
				<td>{{ service.cumulative }}</td>
			</tr>
			</tbody>
		  </table>
		  </div>
		</div>
		
		<div class="panel panel-info">
		  <div class="panel-heading"><button type="button" class="btn btn-default" data-toggle="collapse" data-target="#circuitBreakerTable"  aria-expanded="true" aria-controls="circuitBreakerTable"><span class="caret"></button> Circuit Breakers</div>
		  <div class="panel-body">
			<p>breakers</p>
		  </div>
		  <div id="circuitBreakerTable" class="collapse in">
		  <table class="table table-hover" id="cbTable">
			<thead>
			<tr>
				<th>Name</th>
				<th>Current Failure Count</th>
				<th>Current State</th>
				<th>Failure Threshold</th>
				<th>Recovery Timeout</th>
				<th>Time of Last Trip</th>
				<th>Time Since Last Trip in Seconds</th>
				<th>Time to Next Retry in Seconds</th>
				<th>Total Number Of Trips</th>
			</tr>
			</thead>
			<tbody>
			<tr ng-repeat="cb in main.circuitBreakers">
				<td>{{ cb.name }}</td>
				<td>{{ cb.failureCount }}</td>
				<td><button type="button" class="btn btn-{{ cb.stateClass }}">{{ cb.state }}</button></td>
				<td>{{ cb.threshold }}</td>
				<td>{{ cb.recovery }}</td>
				<td>{{ cb.lastTripTime }}</td>
				<td>{{ cb.timeSinceLastTrip }}</td>
				<td>{{ cb.timeToNextRetry }}</td>
				<td><button type="button" class="btn btn-{{ cb.tripsClass }}">{{ cb.totalNumTrips }}</button></td>
			</tr>
			</tbody>
		  </table>
		  </div>
		</div>

		<div class="panel panel-info">
		  <div class="panel-heading"><button type="button" class="btn btn-default" data-toggle="collapse" data-target="#concurrencyThrottleTable"  aria-expanded="true" aria-controls="concurrencyThrottleTable"><span class="caret"></button> Concurrency Throttles</div>
		  <div class="panel-body">
			<p>throttles</p>
		  </div>
		  <div id="concurrencyThrottleTable" class="collapse in">
		  <table class="table table-hover" id="ctTable">
			<thead>
			<tr>
				<th>Name</th>
				<th>Current Thread Count</th>
				<th>Thread Limit</th>
				<th>Trip Count</th>
			</tr>
			</thead>
			<tbody>
			<tr ng-repeat="ct in main.concurrencyThrottles">
				<td>{{ ct.name }}</td>
				<td>{{ ct.threadCount }}</td>
				<td>{{ ct.threadLimit }}</td>
				<td><button type="button" class="btn btn-{{ ct.tripClass }}">{{ ct.tripCount }}</button></td>
			</tr>
			</tbody>
		  </table>
		  </div>
		</div>
		
		<div class="panel panel-info">
		  <div class="panel-heading"><button type="button" class="btn btn-default" data-toggle="collapse" data-target="#retryTable"  aria-expanded="true" aria-controls="retryTable"><span class="caret"></button> Retry Interceptors</div>
		  <div class="panel-body">
			<p>retries</p>
		  </div>
		  <div id="retryTable" class="collapse in">
		  <table class="table table-hover" id="rtTable">
			<thead>
			<tr>
				<th>Name</th>
				<th>Max Retries</th>
				<th>Number of Accesses</th>
				<th>Retried Operations</th>
				<th>Failed Operations</th>
				<th>Failed Methods</th>
			</tr>
			</thead>
			<tbody>
			<tr ng-repeat="retry in main.retries">
				<td>{{ retry.name }}</td>
				<td>{{ retry.maxRetries }}</td>
				<td>{{ retry.numAccesses }}</td>
				<td><button type="button" class="btn btn-{{ retry.retryClass }}">{{ retry.retriedOperations }}</button></td>
				<td><button type="button" class="btn btn-{{ retry.opsClass }}">{{ retry.failedOperations }}</button></td>
				<td>
					<table class="table table-bordered" ng-if="retry.failedMethods.length > 0">
						<tr><th>Name</th><th>Failures</th></tr>
						<tr ng-repeat="method in retry.failedMethods">
							<td>{{ method.name }}</td>
							<td>{{ method.failures }}</td>
						</tr>
					</table>
				</td>
			</tr>
			</tbody>
		  </table>
		  </div>
		</div>

	</div>
	
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
	<script src="http://cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
	<script type="text/javascript">
		var myApp = angular.module('StabilityMetrics', []);
		
		myApp.controller('MainCtrl', function(DataService) {
			var main = this;
						
			main.performance = DataService.getPerformance();
			
			var bareCbs = DataService.getCircuitBreakers();
			var numCbs = bareCbs.length;
			var stateClasses = {
				"Open": "danger",
				"Closed": "success",
				"HalfOpen": "warning"
			};
			for(var i = 0; i < numCbs; i++) {
				var cb = bareCbs[i];
				cb.stateClass = stateClasses[cb.state];
				cb.tripsClass = cb.totalNumTrips > 0 ? "danger" : "success";
			}
			main.circuitBreakers = bareCbs;
			
			var cts = DataService.getConcurrencyThrottles();
			var numCts = cts.length;
			for(var i = 0; i < numCts; i++) {
				var ct = cts[i];
				ct.tripClass = ct.tripCount > 0 ? "danger" : "success";
			}
			main.concurrencyThrottles = cts;
			
			var rs = DataService.getRetries();
			var numRetries = rs.length;
			for(var i = 0; i < numRetries; i++) {
				var retry = rs[i];
				retry.opsClass = retry.failedOperations > 0 ? "danger" : "success";
				retry.retryClass = retry.retriedOperations > 0 ? "warning" : "success";
			}
			main.retries = rs;
			
			main.getMethodPerformance = function(beanName) {
				return DataService.getMethodPerformance(beanName);
			};
		});
		
		myApp.service('DataService', function() {
			var service = this;
			
			var performance = [
				{
					"name": "ServiceController",
					"min": 1,
					"max": 135,
					"avg": 22,
					"rpm": 17.4, 
					"ex": 0,
					"numAccess": 214,
					"cumulative": 4708
				},
				{
					"name": "ConfigController",
					"min": 1,
					"max": 21,
					"avg": 3,
					"rpm": 94.3, 
					"ex": 0,
					"numAccess": 1334,
					"cumulative": 28014
				}		
			];
			
			var circuitBreakers = [
				{
					"name": "Nice Service",
					"failureCount": 0,
					"state": "Closed",
					"threshold": 3,
					"recovery": 300,
					"lastTripTime": "",
					"timeSinceLastTrip": -1,
					"timeToNextRetry": 0,
					"totalNumTrips": 0
				},
				{
					"name": "Broken Service",
					"failureCount": 3,
					"state": "Open",
					"threshold": 3,
					"recovery": 300,
					"lastTripTime": "Jun 18, 2015 11:06:34 AM PDT",
					"timeSinceLastTrip": 110,
					"timeToNextRetry": 190,
					"totalNumTrips": 4
				}				
			];
			
			var concurrencyThrottles = [
				{
					"name": "Lonely Service",
					"threadLimit": 20,
					"threadCount": 0,
					"tripCount": 0
				},
				{
					"name": "Popular Service",
					"threadLimit": 20,
					"threadCount": 6,
					"tripCount": 2
				}				
			];

			var retries = [
				{
					"name": "Good Service",
					"maxRetries": 3,
					"numAccesses": 305,
					"retriedOperations": 0,
					"failedOperations": 0,
					"failedMethods": {}
				},
				{
					"name": "Bad Service",
					"maxRetries": 3,
					"numAccesses": 213,
					"retriedOperations": 13,
					"failedOperations": 3,
					"failedMethods": [
						{"name": "methodA", "failures": 1},
						{"name": "methodB", "failures": 3}
					]
				}				
			];

			var methodPerformance = [
				{
					"name": "methodNumberOne",
					"min": 2,
					"max": 223,
					"avg": 54,
					"rpm": 19.2, 
					"ex": 0,
					"numAccess": 112,
					"cumulative": 3800
				},
				{
					"name": "methodNumberTwo",
					"min": 1,
					"max": 21,
					"avg": 3,
					"rpm": 94.3, 
					"ex": 0,
					"numAccess": 1334,
					"cumulative": 28014
				}		
			];

			service.getPerformance = function() {
				return performance;
			};
			
			service.getCircuitBreakers = function() {
				return circuitBreakers;
			};
			
			service.getConcurrencyThrottles = function() {
				return concurrencyThrottles;
			};
			
			service.getRetries = function() {
				return retries;
			};
			
			service.getMethodPerformance = function(beanName) {
				console.log(beanName);
				return methodPerformance;
			};
		});
		
		$(document).ready(function() {
			var table = $('#perfTable').DataTable({ "paging": false, "searching": false });
			$('#cbTable').DataTable({ "paging": false, "searching": false });
			$('#ctTable').DataTable({ "paging": false, "searching": false });
			$('#rtTable').DataTable({ "paging": false, "searching": false });
		
			var DataService = angular.injector(['ng', 'StabilityMetrics']).get("DataService")
		    $('#perfTable tbody').on('click', 'tr.details-control', function () {
				var tr = $(this).closest('tr');
				var row = table.row( tr );
				var parentRowName = row.data()[0];
		 
				if ( row.child.isShown() ) {
					// This row is already open - close it
					row.child.hide();
					tr.removeClass('shown');
				}
				else {
					// Open this row
					var data = DataService.getMethodPerformance(parentRowName);
					var dataLength = data.length;
					var rowList = [];
					for(var i = 0; i < dataLength; i++) {
						var m = data[i];
						var t = $('<tr class="bg-info"><td>' + m.name + '</td><td>' + m.min + '</td><td>' + m.max + '</td><td>' + m.avg + '</td><td>' + m.rpm + '</td><td>' + m.ex +'</td><td>' + m.numAccess + '</td><td>' + m.cumulative + '</td></tr>');
						rowList.push(t);
					}
					row.child( rowList ).show();
					tr.addClass('shown');
				}
			});
		});
	</script>
  </body>
</html>